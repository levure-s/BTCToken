<html>
    <head>
        <link rel="stylesheet" href="./style.css">
    </head>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
        <script src="./deployed_info.js"></script>
        <script>
            window.onload = () => {
                if(typeof abi === 'undefined') {
                    document.getElementById('info').innerHTML = "[deployed_info.js]ファイルが見つかりません。確認して下さい。";
                    return;
                }
                if (typeof window.ethereum !== 'undefined') {
                    ethereum.enable().then(() => {
                        window.web3 = new Web3(window.ethereum)
                        init(); 
                    }).catch((err) => {
                        document.getElementById('info').innerHTML = "MetaMaskと接続できませんでした";
                    });
                } else {
                    document.getElementById('info').innerHTML = "MetaMaskが見つかりません";
                }
            }

            async function init(){
                var accounts = await ethereum.send('eth_requestAccounts')
                document.getElementById('livenetwork').innerHTML = deployed_network;
                window.contract = new window.web3.eth.Contract(abi,address);
                window.contract.methods.balanceOf(accounts.result[0]).call((err,res)=>{
                    if(!err){
                        document.getElementById('info').innerHTML =  accounts.result[0];
                        document.getElementById('balance').innerHTML = res;
                    }else{
                        console.log("balanceOfMeerr: " + err);
                    }
                })
		
            }

            async function buyToken(){
                var accounts = await ethereum.send('eth_requestAccounts')
                var amount = document.getElementById('p1amount').value
                var date = window.contract.methods.BuyToken(amount).encodeABI()
                console.log(date)
                var params =[{
                    from: accounts.result[0],
                    to: address,
                    gas: "500000", 
                    data: date
                }]
                ethereum.request({
                    method: 'eth_sendTransaction',
                    params,
                })
                .catch((error) => {
                    document.getElementById('p1result').innerHTML = error;
                });
            }

            async function sellToken(){
                var accounts = await ethereum.send('eth_requestAccounts')
                var amount = document.getElementById('p1amount').value
                var balance = await window.contract.methods.balanceOf(accounts.result[0]).call()
                if(parseInt(balance) < parseInt(amount)){
                    document.getElementById('p1result').innerHTML ="残高不足"
                    console.log("残高不足")
                    return
                }
                var date = window.contract.methods.SellToken(amount).encodeABI()
                console.log(date)
                var params =[{
                    from: accounts.result[0],
                    to: address,
                    gas: "500000", 
                    data: date
                }]
                ethereum.request({
                    method: 'eth_sendTransaction',
                    params,
                })
                .catch((error) => {
                    document.getElementById('p1result').innerHTML = error;
                });
            }
        </script>
        <main>
            <div class="area_title">
                <h1>Bitcoin Token</h1>
                <div class="area_info">
                    <p>Address: <span id="info"></span></p>
                    <p>残高: <span id="balance"></span> BTC</p> 
                    <p>ネットワーク：<span id="livenetwork"></span></p>
                </div>
            </div>
            <hr>
            <div class = "area_p1">
                <h3>◆売買</h3></span><br><br>
                <input type="number" id="p1amount"> <font size="+2"><span>BTC</span></font><br>
                <input type="button" id="p1button" value="購入" onclick="buyToken();"/>
                <input type="button" id="p1button" value="売却" onclick="sellToken();"/>
                　<font color="red"><span id="p1result"></span></font>
            </div>
        </main>
        
    </body>
</html>